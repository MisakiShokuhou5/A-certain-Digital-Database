<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database v3.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="./src/css/json.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <header class="sidebar-header">
                <i class="fas fa-sitemap"></i>
                <h2 id="project-name">Carregando Projeto...</h2>
            </header>
            <div class="search-box">
                <input type="text" id="file-search" placeholder="Buscar arquivo...">
            </div>
            <nav id="file-tree" class="file-tree"></nav>
        </aside>

        <main class="content-viewer">
            <div id="welcome-screen">
                <div class="logo-animation"><i class="fas fa-atom"></i></div>
                <h1>Selecione um arquivo para começar</h1>
                <p>Navegue pela árvore de arquivos à esquerda para carregar os dados.</p>
            </div>
            <div id="viewer-content" class="hidden">
                <header class="viewer-header">
                    <h3 id="file-path-display"></h3>
                    <div class="header-controls">
                        <div id="view-toggle-container" class="view-toggle hidden">
                            <button id="view-formatted-btn" class="active">Formatado</button>
                            <button id="view-raw-btn">Raw JSON</button>
                        </div>
                        <div id="action-buttons-container" class="action-buttons">
                             <button id="copy-path-btn" title="Copiar URL Absoluta"><i class="fas fa-link"></i></button>
                             <button id="copy-content-btn" title="Copiar Conteúdo JSON" class="hidden"><i class="fas fa-copy"></i></button>
                             <button id="generate-fetch-btn" title="Gerar Snippet Fetch" class="hidden"><i class="fas fa-code"></i></button>
                        </div>
                    </div>
                </header>
                <div id="file-content-display"></div>
            </div>
        </main>
    </div>

    <script>
    // JAVASCRIPT ATUALIZADO COM MELHORIAS DE UI E URL ABSOLUTA
    document.addEventListener('DOMContentLoaded', () => {
        const fileTreeEl = document.getElementById('file-tree');
        const projectNameEl = document.getElementById('project-name');
        const welcomeScreen = document.getElementById('welcome-screen');
        const viewerContent = document.getElementById('viewer-content');
        const filePathDisplay = document.getElementById('file-path-display');
        const fileContentDisplay = document.getElementById('file-content-display');
        const viewToggleContainer = document.getElementById('view-toggle-container');
        const viewFormattedBtn = document.getElementById('view-formatted-btn');
        const viewRawBtn = document.getElementById('view-raw-btn');
        
        const copyPathBtn = document.getElementById('copy-path-btn');
        const copyContentBtn = document.getElementById('copy-content-btn');
        const generateFetchBtn = document.getElementById('generate-fetch-btn');

        let fileDatabase = {};
        let currentFile = null;
        let currentView = 'formatted';

        async function initialize() {
            try {
                const manifestResponse = await fetch('manifest.json');
                if (!manifestResponse.ok) throw new Error("manifest.json não encontrado.");
                const manifest = await manifestResponse.json();
                projectNameEl.textContent = manifest.project_name || "Database Local";

                // Carrega apenas os arquivos JSON para o banco de dados em memória
                const jsonFilesToLoad = [];
                function collectJsonFiles(nodes) {
                    for (const node of nodes) {
                        if (node.type === 'file' && node.path.endsWith('.json')) {
                            jsonFilesToLoad.push(node.path);
                        } else if (node.type === 'folder' && node.children) {
                            collectJsonFiles(node.children);
                        }
                    }
                }
                collectJsonFiles(manifest.tree);
                
                const promises = jsonFilesToLoad.map(path => fetch(path).then(res => res.json()));
                const results = await Promise.all(promises);
                jsonFilesToLoad.forEach((path, index) => { fileDatabase[path] = results[index]; });

                buildFileTree(manifest.tree, fileTreeEl);

            } catch (error) {
                console.error("Erro na inicialização:", error);
                welcomeScreen.innerHTML = `<h1>Erro na Inicialização</h1><p style="color:red;">${error.message}</p>`;
            }
        }
        
        // ✨ NOVO: Função para obter ícone com base na extensão do arquivo
        function getFileIcon(path) {
            const extension = path.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
                return 'fas fa-file-image';
            }
            if (extension === 'json') {
                return 'fas fa-file-code';
            }
            return 'fas fa-file-alt'; // Ícone padrão
        }

        function buildFileTree(nodes, parentElement) {
            const ul = document.createElement('ul');
            ul.className = 'tree-node';
            
            for (const node of nodes) {
                const li = document.createElement('li');
                
                if (node.type === 'folder') {
                    li.innerHTML = `
                        <div class="folder-header collapsed">
                            <i class="fas fa-chevron-down icon toggle-icon"></i>
                            <i class="${node.icon || 'fas fa-folder'} icon"></i>
                            <span>${node.name}</span>
                        </div>
                        <div class="folder-content collapsed"></div>
                    `;
                    const folderHeader = li.querySelector('.folder-header');
                    const folderContent = li.querySelector('.folder-content');
                    
                    folderHeader.addEventListener('click', () => {
                        folderContent.classList.toggle('collapsed');
                        folderHeader.classList.toggle('collapsed');
                    });

                    if (node.children) {
                        buildFileTree(node.children, folderContent);
                    }
                } else if (node.type === 'file') {
                    // ✨ NOVO: Usa a função getFileIcon para definir o ícone
                    const iconClass = getFileIcon(node.path);
                    li.innerHTML = `<div class="file-item" data-path="${node.path}"><i class="${iconClass} icon"></i>${node.path.split('/').pop()}</div>`;
                    li.querySelector('.file-item').addEventListener('click', (e) => handleFileSelect(e.currentTarget, node.path));
                }
                ul.appendChild(li);
            }
            parentElement.appendChild(ul);
        }

        function handleFileSelect(element, filePath) {
            document.querySelectorAll('.file-item.active').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            welcomeScreen.classList.add('hidden');
            viewerContent.classList.remove('hidden');
            
            filePathDisplay.textContent = filePath;
            currentFile = filePath;
            
            displayFileContent();
        }

        function displayFileContent() {
            if (!currentFile) return;
            
            const fileExtension = currentFile.split('.').pop().toLowerCase();
            const isJson = fileExtension === 'json';
            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension);
            
            // ✨ NOVO: Lógica de UI Adaptativa
            // Mostra/esconde botões com base no tipo de arquivo
            viewToggleContainer.classList.toggle('hidden', !isJson);
            copyContentBtn.classList.toggle('hidden', !isJson);
            generateFetchBtn.classList.toggle('hidden', !isJson);

            if (isJson) {
                viewFormattedBtn.classList.toggle('active', currentView === 'formatted');
                viewRawBtn.classList.toggle('active', currentView === 'raw');
                const data = fileDatabase[currentFile];
                currentView === 'raw' ? renderRawJson(data) : renderFormattedJson(data);
            } else if (isImage) {
                renderImage(currentFile);
            } else {
                fileContentDisplay.innerHTML = `<p>Visualização não suportada para este tipo de arquivo.</p>`;
            }
        }
        
        function renderRawJson(data) {
            fileContentDisplay.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        // ✨ NOVO: Função de renderização de imagem aprimorada
        function renderImage(filePath) {
            fileContentDisplay.innerHTML = `
                <div class="image-viewer-container">
                    <img src="${filePath}" alt="${filePath}">
                </div>
            `;
        }

        function renderFormattedJson(data) {
            // Esta função permanece a mesma, pois já funciona bem para JSON
            const episodesHtml = (data.episodios || []).map(ep => `
                <div class="episode-item-formatted">
                    <span class="ep-title">Ep. ${ep.episodio || 'N/A'}: ${ep.titulo || 'Sem título'}</span>
                    <p class="ep-desc">${ep.descricao || 'Descrição não disponível.'}</p>
                </div>
            `).join('');
            fileContentDisplay.innerHTML = `
                <div class="formatted-view">
                    <h2 class="anime-title">${data.anime || 'Título Desconhecido'}</h2>
                    <p>${data.sinopse || 'Sinopse não disponível.'}</p>
                    <h4>Episódios</h4>
                    <div class="episode-list-formatted">${episodesHtml || 'Nenhum episódio listado.'}</div>
                </div>
            `;
        }
        
        function provideFeedback(button, originalIconClass) {
            const icon = button.querySelector('i');
            icon.className = 'fas fa-check feedback-icon';
            setTimeout(() => {
                icon.className = originalIconClass;
            }, 1500);
        }

        // --- Event Listeners ---
        document.getElementById('file-search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.file-item, .folder-header').forEach(item => {
                const text = item.textContent.trim().toLowerCase();
                const li = item.closest('li');
                if (li) {
                    li.style.display = text.includes(query) ? '' : 'none';
                }
            });
        });

        viewFormattedBtn.addEventListener('click', () => { currentView = 'formatted'; displayFileContent(); });
        viewRawBtn.addEventListener('click', () => { currentView = 'raw'; displayFileContent(); });

        // ✅ MELHORIA PRINCIPAL: Copia a URL absoluta
        copyPathBtn.addEventListener('click', () => {
            if (!currentFile) return;
            // Constrói a URL absoluta usando a localização atual da página como base
            const absoluteUrl = new URL(currentFile, window.location.href).href;
            navigator.clipboard.writeText(absoluteUrl).then(() => {
                provideFeedback(copyPathBtn, 'fas fa-link');
            });
        });

        copyContentBtn.addEventListener('click', () => {
            if (!currentFile || !fileDatabase[currentFile]) return;
            const content = JSON.stringify(fileDatabase[currentFile], null, 2);
            navigator.clipboard.writeText(content).then(() => {
                provideFeedback(copyContentBtn, 'fas fa-copy');
            });
        });

        generateFetchBtn.addEventListener('click', () => {
            if (!currentFile) return;
            const absoluteUrl = new URL(currentFile, window.location.href).href;
            const fetchSnippet = `fetch('${absoluteUrl}')\n  .then(response => response.json())\n  .then(data => {\n    console.log(data);\n  });`;
            navigator.clipboard.writeText(fetchSnippet).then(() => {
                provideFeedback(generateFetchBtn, 'fas fa-code');
            });
        });

        initialize();
    });
    </script>
</body>
</html>